groups:
  - name: clustergenie_recording_rules
    rules:
      - record: clustergenie_job_processing_seconds_p95
        expr: histogram_quantile(0.95, sum(rate(clustergenie_job_processing_seconds_bucket[5m])) by (le))

      - record: clustergenie_http_request_rate_by_path
        expr: sum(rate(clustergenie_http_requests_total[1m])) by (path, status)

      - record: clustergenie_rate_limit_exceeded_per_endpoint
        expr: sum(rate(clustergenie_rate_limit_exceeded_total[1m])) by (endpoint)

      # Record failure rate for jobs grouped by job_type to speed up dashboard queries
      - record: clustergenie_job_failures_rate_by_type
        expr: sum(rate(clustergenie_jobs_processed_total{status=~"failure|error"}[5m])) by (job_type)

      - record: clustergenie_job_failures_rate_by_cluster
        expr: sum(rate(clustergenie_jobs_processed_total{status=~"failure|error"}[5m])) by (cluster_id)

  - name: clustergenie_alerts
    rules:
      - alert: HighJobLatencyP95
        expr: clustergenie_job_processing_seconds_p95 > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "P95 job processing latency is high (>5s)"
          description: "{{ $labels }} P95 processing latency over 5s for more than 2 minutes."

      - alert: HighWorkerPoolQueueLength
        expr: clustergenie_workerpool_queue_length > 50
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Worker pool queue length is high"
          description: "Worker pool queue length is above 50 for more than 5 minutes. This may indicate backpressure or downstream slowness."

      - alert: RateLimiterSpike
        expr: sum(rate(clustergenie_rate_limit_exceeded_total[5m])) by (endpoint) > 5
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Rate limiter spike detected"
          description: "Rate limiting spikes (>5/m) detected for endpoint {{ $labels.endpoint }}."

      - alert: JobFailureSpikeByType
        expr: clustergenie_job_failures_rate_by_type > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Job failure spike by job_type"
          description: "High failure rate detected for job type {{ $labels.job_type }} (>5 failures/min over 5m average)"

      - alert: JobFailureSpikeByCluster
        expr: clustergenie_job_failures_rate_by_cluster > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Job failure spike by cluster"
          description: "High failure rate detected for cluster {{ $labels.cluster_id }} (>5 failures/min over 5m average)"
